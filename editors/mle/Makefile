# Created by: Adam Saponara <as@php.net>
# $FreeBSD$

PORTNAME=	mle
DISTVERSIONPREFIX=	v
DISTVERSION=	1.4.3
CATEGORIES=	editors

MAINTAINER=	as@php.net
COMMENT=	Small, flexible, terminal-based text editor

LICENSE=	APACHE20
LICENSE_FILE=	${WRKSRC}/LICENSE

BUILD_DEPENDS=	${LOCALBASE}/include/uthash.h:devel/uthash
LIB_DEPENDS=	liblua-5.3.so:lang/lua53 \
		libpcre.so:devel/pcre \
		libtermbox.so:devel/termbox
TEST_DEPENDS=	${LOCALBASE}/bin/gpaste:sysutils/coreutils \
		${LOCALBASE}/bin/grep:textproc/gnugrep \
		bash:shells/bash \
		gfind:misc/findutils

USES=		compiler:c11 gmake localbase:ldflags shebangfix
SHEBANG_FILES=	tests/func/*.sh tests/run.sh
USE_GITHUB=	yes
GH_ACCOUNT=	adsr

PLIST_FILES=	bin/mle
TEST_TARGET=	test

post-patch:
	@${REINPLACE_CMD} -e 's|lua5.3|lua53|g' ${WRKSRC}/mle.h
	@${REINPLACE_CMD} -e 's|lua5.3|lua-5.3|g' ${WRKSRC}/Makefile

	# Tests.
	@${REINPLACE_CMD} -e 's|find|gfind|g' \
		-e 's|grep|${LOCALBASE}/bin/grep|g' \
		${WRKSRC}/tests/run.sh \
		${WRKSRC}/tests/func/*.sh
	@${REINPLACE_CMD} -e 's|p a s t e|g p a s t e|g' \
		${WRKSRC}/tests/func/test_lua.sh

do-install:
	${INSTALL_PROGRAM} ${WRKSRC}/mle ${STAGEDIR}${PREFIX}/bin

pre-test:
	# Remove backup files generated by REINPLACE_CMD. Those must not exist
	# for the tests to run properly.
	@${FIND} ${WRKSRC}/tests -name '*.sh.bak' -delete

.include <bsd.port.mk>
