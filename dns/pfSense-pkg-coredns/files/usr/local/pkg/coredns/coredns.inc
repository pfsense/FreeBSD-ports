<?php

require_once("config.inc");
require_once("functions.inc");
require_once("util.inc");
require_once("service-utils.inc");

define("COREDNS_CONFIG_FILE", "/usr/local/etc/coredns/Corefile");
define("COREDNS_RCFILE", "/usr/local/etc/rc.d/coredns-daemon.sh");
define("COREDNS_DAEMON", "/usr/local/bin/coredns");

function coredns_write_config($coredns_config) {
	$txt = $coredns_config['corefile'];

	// append auto gen warning at bottom of file, so it doesn't mess with line numbers
	$txt .= "\n";
	$txt .= "# This file is generated by the pfSense coredns package.\n";
	$txt .= "# Do not edit this file, it will be overwritten automatically.\n";
	
	if (!file_put_contents(COREDNS_CONFIG_FILE, $txt)) {
		log_error("ERROR: Could not open {" . COREDNS_CONFIG_FILE . "} for writing");
		exit;
	}
}

function coredns_sync_config() {
	global $config;
	global $g;

	if (is_service_running('coredns')) {
		log_error("Stopping service coredns");
		stop_service('coredns');
	}

	$coredns_config = &$config['installedpackages']['coredns']['config'][0];
	if (isset($coredns_config['enable'])) {
		$enable = $coredns_config['enable'];
	} else {
		$enable = 'no';
	}

	if ($enable !== 'yes') {
		unlink_if_exists(COREDNS_RCFILE);
		return;
	}

	/* Write the config file */
	coredns_write_config($coredns_config);

	/* Write the rc script */
	$cmd = COREDNS_DAEMON;
	$start = "	$cmd -conf ";
	$start .= COREDNS_CONFIG_FILE;
	$start .= " > " . $g['varlog_path'] . "/coredns.log" . " 2>&1";
	$stop = "	/usr/bin/killall -q coredns";
	write_rcfile(array(
		"file" => "coredns-daemon.sh",
		"start" => $start,
		"stop" => $stop
		)
	);

	if (platform_booting()) {
		return;
	}

	log_error("Starting service coredns");
	start_service('coredns');
}


function coredns_install_command() {
	coredns_sync_config();
}

function coredns_deinstall_command() {
	if (is_service_running('coredns')) {
		log_error("Stopping service coredns");
		stop_service('coredns');
	}

	unlink_if_exists(COREDNS_RCFILE);
}
