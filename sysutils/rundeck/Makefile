PORTNAME=	rundeck
DISTVERSION=	5.15.0
DISTVERSIONSUFFIX=	-20250902
CATEGORIES=	sysutils java
MASTER_SITES=	https://packagecloud.io/pagerduty/rundeck/packages/java/org.rundeck/${DISTNAME}.war/artifacts/${DISTNAME}.war/download?/
EXTRACT_SUFX=	.war
EXTRACT_ONLY=	#

MAINTAINER=	xavier@groumpf.org
COMMENT=	Web-console for dispatching commands and scripts to your nodes
WWW=		https://www.rundeck.com/

LICENSE=	APACHE20

USES=		cpe java
CPE_VENDOR=	pagerduty
JAVA_VERSION=	11 17
USE_RC_SUBR=	${PORTNAME}

NO_ARCH=	yes
NO_BUILD=	yes
SUB_FILES=	${RUNDECK_LOG4J}
SUB_LIST=	JAVA_HOME=${JAVA_HOME} \
		RUNDECK_CONFIG_DIR=${RUNDECK_CONFIG_DIR} \
		RUNDECK_GROUP=${RUNDECK_GROUP} \
		RUNDECK_HOME=${RUNDECK_HOME} \
		RUNDECK_LOG4J=${RUNDECK_LOG4J} \
		RUNDECK_LOG_FILE=${RUNDECK_LOG_FILE} \
		RUNDECK_LOGDIR=${RUNDECK_LOGDIR} \
		RUNDECK_USER=${RUNDECK_USER}

RUNDECK_HOME=		${PREFIX}/${PORTNAME}
RUNDECK_USER?=		${PORTNAME}
RUNDECK_GROUP?=		${PORTNAME}
RUNDECK_LOGDIR?=	/var/log/${PORTNAME}
RUNDECK_LOG_FILE?=	${RUNDECK_LOGDIR}/${PORTNAME}.log
RUNDECK_LOG4J=		log4j2.properties
RUNDECK_CONFIG_DIR=	${RUNDECK_HOME}/server/config

.if ${RUNDECK_USER} == ${PORTNAME}
USERS=		${PORTNAME}
.endif
.if ${RUNDECK_GROUP} == ${PORTNAME}
GROUPS=		${PORTNAME}
.endif

PLIST_SUB=	NAME=${PORTNAME}${EXTRACT_SUFX} \
		RUNDECK_GROUP=${RUNDECK_GROUP} \
		RUNDECK_HOME=${RUNDECK_HOME} \
		RUNDECK_LOGDIR=${RUNDECK_LOGDIR} \
		RUNDECK_USER=${RUNDECK_USER}

do-install:
	${MKDIR} ${STAGEDIR}${DATADIR} \
		 ${STAGEDIR}${RUNDECK_HOME}/server/lib \
		 ${STAGEDIR}${RUNDECK_LOGDIR}
	${INSTALL_DATA} ${DISTDIR}/${DISTNAME}${EXTRACT_SUFX} \
		${STAGEDIR}${DATADIR}/${PORTNAME}${EXTRACT_SUFX}

post-install:
	${MKDIR} ${STAGEDIR}${RUNDECK_CONFIG_DIR}
	${INSTALL_DATA} \
		${WRKDIR}/${RUNDECK_LOG4J} \
		${STAGEDIR}${RUNDECK_CONFIG_DIR}/${RUNDECK_LOG4J}

.include <bsd.port.mk>
