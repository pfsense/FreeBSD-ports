# Created by: Iblis Lin <iblis@hs.ntnu.edu.tw>
# $FreeBSD$

PORTNAME=	libwebsockets
DISTVERSIONPREFIX=	v
DISTVERSION=	4.0.21
CATEGORIES=	net devel

MAINTAINER=	iblis@hs.ntnu.edu.tw
COMMENT=	C library for lightweight websocket clients and servers

LICENSE=	MIT
LICENSE_FILE=	${WRKSRC}/LICENSE

USES=		cmake pkgconfig ssl
USE_LDCONFIG=	yes

PORTSCOUT=	limit:^v\d+\.*

USE_GITHUB=	yes
GH_ACCOUNT=	warmcat

CMAKE_ARGS=	-DLWS_WITHOUT_TESTAPPS=ON \
		-DLWS_WITHOUT_TEST_SERVER=ON \
		-DLWS_WITHOUT_TEST_SERVER_EXTPOLL=ON \
		-DLWS_WITHOUT_TEST_PING=ON \
		-DLWS_WITHOUT_TEST_CLIENT=ON

OPTIONS_DEFINE=	HTTP2 HTTP_PROXY IPV6 LIBEV LIBUV UNIX_SOCK WEBSERVER PLUGINS \
		SOCKS5 MQTT SECURE_STREAMS
OPTIONS_DEFAULT=HTTP2 LIBUV
OPTIONS_SUB=	yes

HTTP2_DESC=	Compile with server support for HTTP/2
HTTP_PROXY_DESC=	HTTP proxy support
LIBUV_DESC=	Asynchronous I/O support via libuv
UNIX_SOCK_DESC=	Unix domain socket support
SOCKS5_DESC=	Allow use of SOCKS5 proxy on client connections
MQTT_DESC=		MQTT client support
SECURE_STREAMS_DESC=	Secure Streams API support

HTTP2_CMAKE_ON=	-DLWS_WITH_HTTP2=ON

HTTP_PROXY_CMAKE_ON=	-DLWS_WITH_HTTP_PROXY=ON \
			-DLIBHUBBUB_LIBRARIES=${LOCALBASE}/lib/libhubbub.so
HTTP_PROXY_LIB_DEPENDS=	libhubbub.so:www/libhubbub

IPV6_CMAKE_ON=	-DLWS_IPV6=ON

LIBEV_CMAKE_ON=	-DLWS_WITH_LIBEV=ON
LIBEV_LIB_DEPENDS=	libev.so:devel/libev

LIBUV_CMAKE_ON=	-DLWS_WITH_LIBUV=ON
LIBUV_LIB_DEPENDS=	libuv.so:devel/libuv

UNIX_SOCK_CMAKE_ON=	-DLWS_UNIX_SOCK=ON

WEBSERVER_CMAKE_ON=	-DLWS_WITH_LWSWS=ON
WEBSERVER_IMPLIES=	LIBUV

PLUGINS_CMAKE_ON=	-DLWS_WITH_PLUGINS=ON \
			-DLWS_WITH_SERVER_STATUS=ON \
			-DLWS_WITH_GENERIC_SESSIONS=ON
PLUGINS_LIB_DEPENDS=	libsqlite3.so:databases/sqlite3

SOCKS5_CMAKE_ON=	-DLWS_WITH_SOCKS5=ON

MQTT_CMAKE_ON=		-DLWS_ROLE_MQTT=ON

SECURE_STREAMS_CMAKE_ON=-DLWS_WITH_SECURE_STREAMS=ON \
			-DLWS_WITH_SECURE_STREAMS_PROXY_API=ON \
			-DLWS_WITH_SECURE_STREAMS_SYS_AUTH_API_AMAZON_COM=ON

.include <bsd.port.mk>
