From cf2bbcfff2985c116552967c7c4522f4630f2d18 Mon Sep 17 00:00:00 2001
From: Nobuyoshi Nakada <nobu@ruby-lang.org>
Date: Fri, 11 Jun 2021 00:06:43 +0900
Subject: [PATCH 1/2] Just free compiled pattern if no space is used

https://hackerone.com/reports/1220911
---
 regcomp.c                | 14 ++++++++------
 test/ruby/test_regexp.rb |  9 +++++++++
 2 files changed, 17 insertions(+), 6 deletions(-)

diff --git regcomp.c regcomp.c
index 3e65c9d2e3..94640639d8 100644
--- regcomp.c
+++ regcomp.c
@@ -142,8 +142,13 @@ bitset_on_num(BitSetRef bs)
 static void
 onig_reg_resize(regex_t *reg)
 {
-  resize:
-    if (reg->alloc > reg->used) {
+  do {
+    if (!reg->used) {
+      xfree(reg->p);
+      reg->alloc = 0;
+      reg->p = 0;
+    }
+    else if (reg->alloc > reg->used) {
       unsigned char *new_ptr = xrealloc(reg->p, reg->used);
       // Skip the right size optimization if memory allocation fails
       if (new_ptr) {
@@ -151,10 +156,7 @@ onig_reg_resize(regex_t *reg)
         reg->p = new_ptr;
       }
     }
-    if (reg->chain) {
-      reg = reg->chain;
-      goto resize;
-    }
+  } while ((reg = reg->chain) != 0);
 }
 
 extern int
diff --git test/ruby/test_regexp.rb test/ruby/test_regexp.rb
index 4be6d7bec7..84687c5380 100644
--- test/ruby/test_regexp.rb
+++ test/ruby/test_regexp.rb
@@ -1431,6 +1431,15 @@ def test_bug18631
     assert_kind_of MatchData, /(?<x>a)(?<x>aa)\k<x>/.match("aaaab")
   end
 
+  def test_invalid_group
+    assert_separately([], "#{<<-"begin;"}\n#{<<-'end;'}")
+    begin;
+      assert_raise_with_message(RegexpError, /invalid conditional pattern/) do
+        Regexp.new("((?(1)x|x|)x)+")
+      end
+    end;
+  end
+
   # This assertion is for porting x2() tests in testpy.py of Onigmo.
   def assert_match_at(re, str, positions, msg = nil)
     re = Regexp.new(re) unless re.is_a?(Regexp)
-- 
2.35.2

